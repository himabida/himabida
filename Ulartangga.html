<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ular Tangga Truth or Dare (Online & Offline)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Righteous&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #564FD8;
            --secondary: #FF6584;
            --dark: #2D3748;
            --light: #F7FAFC;
            --success: #48BB78;
            --danger: #F56565;
            --warning: #F6AD55;
            --gray: #A0AEC0;
            --dark-gray: #4A5568;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === SCREEN STYLES === */
        .screen {
            display: none;
            width: 100%;
            animation: fadeIn 0.5s;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === HEADER STYLES === */
        .game-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .game-title {
            font-family: 'Righteous', cursive;
            font-size: 3rem;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--dark-gray);
            font-weight: 400;
        }

        /* === BUTTON STYLES === */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #e64c6d;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* === CARD STYLES === */
        .card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 1rem 0;
            width: 100%;
            max-width: 800px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* === PLAYER INPUT === */
        .player-input-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 2rem 0;
            width: 100%;
        }

        .player-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .color-preview:hover {
            transform: scale(1.1);
        }

        .player-input input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .player-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
        }

        /* === GAME BOARD === */
        .board-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin: 2rem auto;
            perspective: 1000px;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            width: 100%;
            background-color: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transform-style: preserve-3d;
            transform: rotateX(5deg);
            position: relative;
            z-index: 1;
        }

        .board::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 5%;
            width: 90%;
            height: 20px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            filter: blur(10px);
            z-index: -1;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
            border-radius: 8px;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        }

        .cell:hover {
            transform: scale(1.05);
            z-index: 5;
        }

        .cell.snake {
            background: linear-gradient(135deg, var(--danger), #fc8181);
            color: white;
        }

        .cell.ladder {
            background: linear-gradient(135deg, var(--success), #68d391);
            color: white;
        }

        .cell.warning {
            background: linear-gradient(135deg, var(--warning), #f6ad55);
            color: white;
        }

        .cell-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.7rem;
            color: var(--dark-gray);
        }

        .piece {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: absolute;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }

        /* === SCOREBOARD === */
        .scoreboard {
            background-color: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem auto;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .scoreboard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .scoreboard h3 {
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .scoreboard h3::before {
            content: 'üèÜ';
            margin-right: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #edf2f7;
            align-items: center;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .player-rank {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .player-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .player-position {
            background-color: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* === CONTROLS === */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 2rem 0;
        }

        .dice-container {
            position: relative;
            width: 80px;
            height: 80px;
            perspective: 1000px;
        }

        .dice {
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
            position: relative;
            cursor: pointer;
        }

        .dice::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.1);
            pointer-events: none;
        }

        .dice.rolling {
            animation: rollDice 0.5s ease-in-out infinite;
        }

        @keyframes rollDice {
            0%, 100% { transform: rotateX(0) rotateY(0); }
            25% { transform: rotateX(90deg) rotateY(0); }
            50% { transform: rotateX(180deg) rotateY(90deg); }
            75% { transform: rotateX(0) rotateY(180deg); }
        }

        /* === CURRENT TURN === */
        .current-turn {
            font-weight: 700;
            text-align: center;
            margin: 1rem 0;
            padding: 12px 20px;
            background-color: white;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
        }

        .current-turn-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* === VOICE CONTROL === */
        .voice-control {
            text-align: center;
            margin: 1rem 0;
        }

        .mic-status {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-top: 0.5rem;
        }

        .mic-btn {
            background-color: var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(108, 99, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mic-btn::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mic-btn:hover::before {
            opacity: 1;
        }

        .mic-btn i {
            font-size: 1.5rem;
            color: white;
        }

        .mic-btn.active {
            background-color: var(--success);
            box-shadow: 0 6px 12px rgba(72, 187, 120, 0.3);
            animation: pulse 1.5s infinite;
        }

        .mic-btn.error {
            background-color: var(--danger);
            box-shadow: 0 6px 12px rgba(245, 101, 101, 0.3);
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            animation: modalOpen 0.3s ease forwards;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        @keyframes modalOpen {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .task-card {
            background: linear-gradient(135deg, #f6f9fc 0%, #eef2f5 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 5px solid var(--primary);
            text-align: left;
        }

        .task-card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .task-card p {
            color: var(--dark);
            font-size: 1rem;
            line-height: 1.5;
        }

        /* === WINNER ANIMATION === */
        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            opacity: 0;
            z-index: 999;
            animation: confetti 3s ease-out;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        .winner-glow {
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(108, 99, 255, 0.4) 0%, rgba(108, 99, 255, 0) 70%);
            border-radius: 50%;
            animation: glowPulse 2s infinite alternate;
            z-index: -1;
        }

        @keyframes glowPulse {
            from { transform: scale(0.8); opacity: 0.6; }
            to { transform: scale(1.2); opacity: 0.9; }
        }

        /* === ONLINE GAME STYLES === */
        .mode-select {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .mode-card {
            background-color: white;
            border-radius: 16px;
            padding: 2rem;
            width: 280px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .mode-card i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .mode-card h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .mode-card p {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .room-code {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 5px;
            color: var(--primary);
            margin: 1rem 0;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }

        .room-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 1.5rem 0;
        }

        .room-option {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .room-option label {
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .room-option input, .room-option select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .room-option input:focus, .room-option select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .lobby {
            width: 100%;
            max-width: 500px;
            margin: 1rem auto;
        }

        .player-list {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #edf2f7;
            align-items: center;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-info {
            display: flex;
            align-items: center;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .player-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            background-color: #e2e8f0;
            color: var(--dark-gray);
        }

        .player-status.ready {
            background-color: var(--success);
            color: white;
        }

        .player-status.admin {
            background-color: var(--primary);
            color: white;
        }

        /* === CUSTOM TASK STYLES === */
        .task-mode-select {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 2rem 0;
        }

        .task-mode-card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }

        .task-mode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .task-mode-card.selected {
            border-color: var(--primary);
            background-color: rgba(108, 99, 255, 0.05);
        }

        .task-mode-card i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .task-mode-card h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .custom-task-container {
            width: 100%;
            max-width: 600px;
            margin: 1rem auto;
        }

        .custom-task-form {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-input-group {
            margin-bottom: 1rem;
        }

        .task-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .task-input-group input, .task-input-group textarea, .task-input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        .task-input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .task-input-group input:focus, .task-input-group textarea:focus, .task-input-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .task-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }

        .task-list {
            margin-top: 1.5rem;
        }

        .task-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item-info {
            flex: 1;
        }

        .task-item-type {
            font-weight: bold;
            color: var(--primary);
        }

        .task-item-cell {
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .task-item-delete {
            color: var(--danger);
            cursor: pointer;
            margin-left: 10px;
        }

        .player-task-progress {
            text-align: center;
            margin: 1rem 0;
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .player-input-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .board {
                grid-template-columns: repeat(10, 1fr);
                gap: 2px;
                padding: 10px;
            }
            
            .cell {
                font-size: 10px;
            }
            
            .piece {
                width: 18px;
                height: 18px;
                font-size: 0.6rem;
            }
            
            .dice-container {
                width: 60px;
                height: 60px;
            }
            
            .dice {
                font-size: 1.5rem;
            }

            .mode-select {
                flex-direction: column;
                align-items: center;
            }

            .mode-card {
                width: 100%;
                max-width: 300px;
            }

            .task-mode-select {
                flex-direction: column;
                align-items: center;
            }

            .task-mode-card {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 1.8rem;
            }
            
            .player-input-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 1.5rem;
            }

            .task-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* === UTILITY CLASSES === */
        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

</head>
    <body>
    <div class="container">
        <!-- SCREEN 1: START MENU -->
        <div class="screen active" id="start-screen">
            <div class="game-header">
                <h1 class="game-title">Ular Tangga</h1>
                <h2 class="game-subtitle">Truth or Dare</h2>
                <h2 class="game-subtitle">Powered By HIMABIDA</h2>
            </div>
            <div class="card">
                <img src="ular.jpeg" alt="Game Illustration" style="width: 100%; max-width: 300px; margin: 0 auto 1rem; display: block;">
                <button id="start-btn" class="btn btn-secondary">
                    <i class="fas fa-play mr-1"></i> Mulai Game
                </button>
            </div>
        </div>

        <!-- SCREEN 2: MODE SELECTION -->
        <div class="screen" id="mode-screen">
            <div class="card">
                <h1 class="text-center">Pilih Mode Permainan</h1>
                <p class="text-center">Main sendiri atau bersama teman secara online?</p>
                
                <div class="mode-select">
                    <div class="mode-card" id="offline-mode">
                        <i class="fas fa-user-friends"></i>
                        <h3>Offline</h3>
                        <p>Main sendiri dengan teman-teman di satu perangkat</p>
                    </div>
                    <div class="mode-card" id="online-mode">
                        <i class="fas fa-globe"></i>
                        <h3>Online</h3>
                        <p>Main bersama teman secara online dari jarak jauh</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: RULES (OFFLINE) -->
        <div class="screen" id="rules-screen">
            <div class="card">
                <h1 class="text-center">Aturan Main</h1>
                <div class="rules-list">
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-users"></i> </div>
                            <p>: Pilih jumlah pemain (2-8 orang)</p>
                    </div>></i> </div>
                        
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-palette"></i></div>
                        <p>: Setiap pemain akan dapat pion warna berbeda</p>
                        
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-microphone"></i></div>
                        <p><strong>Bilang "MULAI" untuk lempar dadu</strong> (atau klik tombol)</p>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-snake"></i></div>
                        <p>Jika mendarat di:</p>
                        <ul>
                            <li><span style="color: var(--success);">Tangga (Hijau)</span>: Naik ke posisi spesifik</li>
                            <li><span style="color: var(--danger);">Ular (Merah)</span>: Turun ke posisi spesifik</li>
                            <li><span style="color: var(--warning);">Truth/Dare (Kuning)</span>: Pilih tantangan!</li>
                        </ul>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-trophy"></i></div>
                        <p>Pemain pertama yang sampai di kotak 100 menang!</p>
                    </div>
                </div>
                <button id="next-btn" class="btn">
                    Selanjutnya <i class="fas fa-arrow-right ml-1"></i>
                </button>
            </div>
        </div>

        <!-- SCREEN 4: PLAYER COUNT (OFFLINE) -->
        <div class="screen" id="count-screen">
            <div class="card">
                <h1 class="text-center">Jumlah Pemain</h1>
                <p class="text-center">Pilih jumlah pemain:</p>
                <div class="player-count-buttons">
                    <button class="count-btn btn btn-outline" data-count="2">
                        <i class="fas fa-user-friends mr-1"></i> 2 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="3">
                        <i class="fas fa-users mr-1"></i> 3 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="4">
                        <i class="fas fa-users mr-1"></i> 4 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="5">
                        <i class="fas fa-users mr-1"></i> 5 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="6">
                        <i class="fas fa-users mr-1"></i> 6 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="7">
                        <i class="fas fa-users mr-1"></i> 7 Pemain
                    </button>
                    <button class="count-btn btn btn-outline" data-count="8">
                        <i class="fas fa-users mr-1"></i> 8 Pemain
                    </button>
                </div>
            </div>
        </div>

        <!-- SCREEN 5: PLAYER NAMES (OFFLINE) -->
        <div class="screen" id="names-screen">
            <div class="card">
                <h1 class="text-center">Input Nama Pemain</h1>
                <div id="player-inputs" class="player-input-container"></div>
                <button id="start-game-btn" class="btn">
                    <i class="fas fa-gamepad mr-1"></i> Lanjut
                </button>
            </div>
        </div>

        <!-- SCREEN 5.5: TASK MODE SELECTION (OFFLINE) -->
        <div class="screen" id="task-mode-screen">
            <div class="card">
                <h1 class="text-center">Pilih Mode Tantangan</h1>
                <p class="text-center">Pilih jenis tantangan yang akan digunakan dalam permainan</p>
                
                <div class="task-mode-select">
                    <div class="task-mode-card" id="system-mode">
                        <i class="fas fa-robot"></i>
                        <h3>System</h3>
                        <p>Gunakan tantangan yang sudah disediakan oleh sistem</p>
                    </div>
                    <div class="task-mode-card" id="manual-mode">
                        <i class="fas fa-users-cog"></i>
                        <h3>Manual</h3>
                        <p>Buat tantangan sendiri untuk setiap pemain</p>
                    </div>
                </div>
                
                <button id="task-mode-confirm" class="btn mt-3">
                    <i class="fas fa-check mr-1"></i> Konfirmasi
                </button>
            </div>
        </div>

        <!-- SCREEN 5.6: CUSTOM TASK INPUT (OFFLINE) -->
        <div class="screen" id="custom-task-screen">
            <div class="card">
                <h1 class="text-center">Buat Tantangan</h1>
                <div class="player-task-progress" id="player-task-progress">
                    Sekarang giliran: <span id="current-player-name"></span> (Pemain <span id="current-player-number"></span> dari <span id="total-players"></span>)
                </div>
                
                <div class="custom-task-container">
                    <div class="custom-task-form">
                        <div class="task-input-group">
                            <label for="task-type">Jenis Tantangan</label>
                            <select id="task-type">
                                <option value="truth">Truth</option>
                                <option value="dare">Dare</option>
                            </select>
                        </div>
                        <div class="task-input-group">
                            <label for="task-text">Tantangan</label>
                            <textarea id="task-text" placeholder="Masukkan tantangan truth atau dare"></textarea>
                        </div>
                        <div class="task-input-group">
                            <label for="task-cell">Kotak Papan (1-100)</label>
                            <input type="number" id="task-cell" min="1" max="100" placeholder="Masukkan nomor kotak">
                        </div>
                        
                        <div class="task-buttons">
                            <button id="add-task-btn" class="btn btn-small">
                                <i class="fas fa-plus mr-1"></i> Tambah
                            </button>
                            <button id="finish-tasks-btn" class="btn btn-small btn-secondary" disabled>
                                <i class="fas fa-check mr-1"></i> Selesai
                            </button>
                        </div>
                        
                        <div class="task-list" id="task-list">
                            <p class="text-center">Belum ada tantangan ditambahkan</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 6: ONLINE MODE SELECTION -->
        <div class="screen" id="online-options-screen">
            <div class="card">
                <h1 class="text-center">Mode Online</h1>
                <p class="text-center">Buat room baru atau gabung room yang sudah ada</p>
                
                <div class="mode-select">
                    <div class="mode-card" id="create-room-btn">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Buat Room</h3>
                        <p>Buat room baru dan undang teman untuk bergabung</p>
                    </div>
                    <div class="mode-card" id="join-room-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        <h3>Gabung Room</h3>
                        <p>Gabung ke room yang sudah ada dengan kode room</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 7: CREATE ROOM -->
        <div class="screen" id="create-room-screen">
            <div class="card">
                <h1 class="text-center">Buat Room Baru</h1>
                
                <div class="room-options">
                    <div class="room-option">
                        <label for="player-name">Nama Anda</label>
                        <input type="text" id="host-name" placeholder="Masukkan nama Anda">
                    </div>
                    <div class="room-option">
                        <label for="max-players">Jumlah Pemain</label>
                        <select id="max-players">
                            <option value="2">2 Pemain</option>
                            <option value="3">3 Pemain</option>
                            <option value="4">4 Pemain</option>
                            <option value="5">5 Pemain</option>
                            <option value="6">6 Pemain</option>
                            <option value="7">7 Pemain</option>
                            <option value="8">8 Pemain</option>
                        </select>
                    </div>
                    <div class="room-option">
                        <label for="task-mode">Mode Tantangan</label>
                        <select id="task-mode">
                            <option value="system">System (Tantangan dari game)</option>
                            <option value="manual">Manual (Buat tantangan sendiri)</option>
                        </select>
                    </div>
                </div>
                
                <button id="create-room-confirm" class="btn">
                    <i class="fas fa-plus-circle mr-1"></i> Buat Room
                </button>
            </div>
        </div>

        <!-- SCREEN 8: ROOM LOBBY (HOST) -->
        <div class="screen" id="host-lobby-screen">
    <div class="card">
        <h1 class="text-center">Room Anda</h1>
        <p class="text-center">Bagikan kode ini ke teman Anda:</p>
        <div class="room-code" id="room-code-display">ABCD12</div>

        <div class="lobby">
            <h3><i class="fas fa-users mr-1"></i> Pemain di Room</h3>
            <div class="player-list" id="host-player-list">
                <!-- Player list will be populated here -->
            </div>
        </div>

        <div id="host-custom-tasks-section" style="display: none;">
            <h3><i class="fas fa-tasks mr-1"></i> Tantangan Kustom</h3>
            <p class="text-center">Silakan buat tantangan untuk permainan</p>
            <button id="host-setup-tasks-btn" class="btn btn-small">
                <i class="fas fa-edit mr-1"></i> Buat Tantangan
            </button>
        </div>

        <button id="host-start-btn" class="btn" disabled>
            <i class="fas fa-play mr-1"></i> Mulai Game
        </button>
    </div>
        </div>

        <!-- SCREEN 9: JOIN ROOM -->
        <div class="screen" id="join-room-screen">
            <div class="card">
                <h1 class="text-center">Gabung Room</h1>
                
                <div class="room-options">
                    <div class="room-option">
                        <label for="join-player-name">Nama Anda</label>
                        <input type="text" id="join-player-name" placeholder="Masukkan nama Anda">
                    </div>
                    <div class="room-option">
                        <label for="room-code">Kode Room</label>
                        <input type="text" id="room-code" placeholder="Masukkan kode room">
                    </div>
                </div>
                
                <button id="join-room-confirm" class="btn">
                    <i class="fas fa-sign-in-alt mr-1"></i> Gabung Room
                </button>
            </div>
        </div>

        <!-- SCREEN 10: ROOM LOBBY (GUEST) -->
        <div class="screen" id="guest-lobby-screen">
    <div class="card">
        <h1 class="text-center">Room</h1>
        <p class="text-center">Kode Room: <span class="room-code" id="guest-room-code">ABCD12</span></p>

        <div class="lobby">
            <h3><i class="fas fa-users mr-1"></i> Pemain di Room</h3>
            <div class="player-list" id="guest-player-list">
                <!-- Player list will be populated here -->
            </div>
        </div>

        <div id="guest-custom-tasks-section" style="display: none;">
            <h3><i class="fas fa-tasks mr-1"></i> Tantangan Kustom</h3>
            <p class="text-center">Silakan buat tantangan untuk permainan</p>
            <button id="guest-setup-tasks-btn" class="btn btn-small">
                <i class="fas fa-edit mr-1"></i> Buat Tantangan
            </button>
        </div>

        <button id="guest-ready-btn" class="btn">
            <i class="fas fa-check mr-1"></i> Ready
        </button>

        <p class="text-center">Menunggu admin memulai game...</p>
    </div>
</div>

        <!-- SCREEN 11: ONLINE RULES -->
        <div class="screen" id="online-rules-screen">
            <div class="card">
                <h1 class="text-center">Aturan Main</h1>
                <div class="rules-list">
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-users"></i></div>
                        <p>Game akan berjalan secara bergiliran</p>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-palette"></i></div>
                        <p>Setiap pemain akan dapat pion warna berbeda</p>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-microphone"></i></div>
                        <p><strong>Bilang "MULAI" untuk lempar dadu</strong> (atau klik tombol)</p>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-snake"></i></div>
                        <p>Jika mendarat di:</p>
                        <ul>
                            <li><span style="color: var(--success);">Tangga (Hijau)</span>: Naik ke posisi spesifik</li>
                            <li><span style="color: var(--danger);">Ular (Merah)</span>: Turun ke posisi spesifik</li>
                            <li><span style="color: var(--warning);">Truth/Dare (Kuning)</span>: Pilih tantangan!</li>
                        </ul>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon"><i class="fas fa-trophy"></i></div>
                        <p>Pemain pertama yang sampai di kotak 100 menang!</p>
                    </div>
                </div>
                <button id="online-start-btn" class="btn">
                    <i class="fas fa-play mr-1"></i> Mulai Game
                </button>
            </div>
        </div>

        <!-- SCREEN 12: GAME BOARD (FOR BOTH OFFLINE AND ONLINE) -->
        <div class="screen" id="game-screen">
            <div class="game-header">
                <h1 class="game-title">Ular Tangga</h1>
                <h2 class="game-subtitle">Truth or Dare Edition</h2>
                <div id="online-status" style="display: none;">
                    <span id="room-code-badge" class="player-status admin"></span>
                    <span id="connection-status" class="player-status ready"></span>
                </div>
            </div>
            
            <div class="scoreboard">
                <h3><i class="fas fa-trophy mr-1"></i> Scoreboard</h3>
                <div id="score-list"></div>
            </div>
            
            <div class="board-container">
                <div class="board" id="game-board"></div>
            </div>
            
            <div class="current-turn" id="current-turn">
                <div class="current-turn-indicator"></div>
                <span id="turn-text">Giliran: Player 1</span>
            </div>
            
            <div class="controls">
                <button id="roll-btn" class="btn btn-secondary">
                    <i class="fas fa-dice mr-1"></i> Lempar Dadu
                </button>
                <div class="dice-container">
                    <div class="dice" id="dice">?</div>
                </div>
            </div>

            <!-- VOICE CONTROL -->
            <div class="voice-control">
                <div class="mic-btn" id="mic-btn">
                    <i class="fas fa-microphone"></i>
                </div>
                <p class="mic-status" id="mic-status">Klik mic atau bilang "MULAI"</p>
            </div>
        </div>

        <!-- MODAL: TRUTH/DARE -->
        <div class="modal" id="truth-dare-modal" style="display: none;">
            <div class="modal-content">
                <div class="winner-glow"></div>
                <h2>PILIH:</h2>
                <div class="modal-buttons">
                    <button id="truth-btn" class="btn">
                        <i class="fas fa-comment-dots mr-1"></i> Truth
                    </button>
                    <button id="dare-btn" class="btn btn-secondary">
                        <i class="fas fa-running mr-1"></i> Dare
                    </button>
                </div>
                <div id="task-result"></div>
                <button id="continue-btn" class="btn" style="display: none; margin-top: 1rem;">
                    Lanjutkan <i class="fas fa-arrow-right ml-1"></i>
                </button>
            </div>
        </div>

        <!-- MODAL: WINNER -->
        <div class="modal" id="winner-modal" style="display:none">
            <div class="modal-content">
                <div class="winner-glow"></div>
                <h2><i class="fas fa-trophy mr-1"></i> Selamat!</h2>
                <p id="winner-name" style="font-size: 2rem; font-weight: bold; margin: 1rem 0;"></p>
                <button id="play-again-btn" class="btn btn-secondary">
                    <i class="fas fa-redo mr-1"></i> Main Lagi
                </button>
            </div>
        </div>
    </div>
  <div id="game-container"></div>

<script>

// === FIREBASE INITIALIZATION ===
const firebaseConfig = {
  apiKey: "AIzaSyAaYFKvIjfMfYbv5rZ6X5MZrLDtgj5QOEc",
  authDomain: "ulartangga-online.firebaseapp.com",
  databaseURL: "https://ulartangga-online-default-rtdb.firebaseio.com",
  projectId: "ulartangga-online",
  storageBucket: "ulartangga-online.firebasestorage.app",
  messagingSenderId: "344900787531",
  appId: "1:344900787531:web:d24f270489c1fdff8d1cce"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// === GAME DATA ===
const colors = [
    '#FF6584', // Merah muda
    '#6C63FF', // Ungu
    '#48BB78', // Hijau
    '#F6AD55', // Oranye
    '#9F7AEA', // Lavender
    '#4299E1', // Biru
    '#ED8936', // Jingga
    '#667EEA'  // Biru ungu
];

// Posisi ular & tangga
const snakes = {
    57: 34, // Turun dari 57 ke 34
    30: 21, // Turun dari 30 ke 21
    87: 68, // Turun dari 87 ke 68
    15: 5,  // Turun dari 15 ke 5
    60: 40  // Turun dari 60 ke 40
};

const ladders = {
    10: 24, // Naik dari 10 ke 24
    75: 90, // Naik dari 75 ke 90
    43: 53, // Naik dari 43 ke 53
    38: 46, // Naik dari 38 ke 46
    5: 17   // Naik dari 5 ke 17
};

const warningCells = [12, 22, 35, 48, 63, 77, 85, 95];

const tasks = {
    truth: [
        "Pernah naksir teman sendiri? Ceritakan!",
        "Apa rahasia yang belum pernah kamu ceritakan ke siapapun?",
        "Pernah nyontek saat ujian? Kapan terakhir kali?",
        "Kalau bisa jadi binatang, mau jadi apa dan kenapa?",
        "Apa hal paling memalukan yang pernah terjadi padamu?",
        "Apa kebiasaan anehmu yang tidak diketahui orang lain?",
        "Pernah berbohong ke orang tua tentang apa?",
        "Apa hal paling bodoh yang pernah kamu lakukan?"
    ],
    dare: [
        "Tirukan suara ayam selama 10 detik!",
        "Minum air tanpa menggunakan tangan",
        "Tari seperti bebek selama 30 detik",
        "Panggil aku 'Yang Mulia' sampai giliranmu berikutnya",
        "Tirukan gaya jalan model di catwalk",
        "Nyanyi lagu anak kecil dengan suara keras",
        "Biarkan orang sebelahmu menggambar di wajahmu",
        "Ucapkan alfabet terbalik dari Z ke A"
    ]
};

// Game state
let players = [];
let positions = {};
let currentPlayer = 0;
let playerCount = 0;
let recognition;
let isListening = false;
let isOnlineGame = false;
let isHost = false;
let roomCode = '';
let myPlayerId = '';
let maxPlayers = 2;
let taskMode = 'system'; // 'system' or 'manual'
let customTasks = {};
let currentTaskPlayer = 0;
let playerTasks = [];
let roomRef = null;

// === FIREBASE FUNCTIONS ===
function generateId() {
    return 'player-' + Math.random().toString(36).substr(2, 9);
}

function generateRoomCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}
function createRoom(playerName) {
    myPlayerId = generateId();
    roomCode = generateRoomCode();
    roomRef = database.ref('rooms/' + roomCode);
    
    const roomData = {
        host: myPlayerId,
        players: {
            [myPlayerId]: {
    
                name: playerName,
                position: 1,
                color: colors[0],
                ready: false, // Admin belum ready
                tasksCompleted: false, // Tandai belum selesai tantangan
                isCurrent: false
            }
        },
        currentPlayer: myPlayerId,
        status: "waiting",
        maxPlayers: maxPlayers,
        taskMode: taskMode,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    return roomRef.set(roomData).then(() => {
        setupRoomListeners();
        document.getElementById('room-code-display').textContent = roomCode;
        switchScreen('host-lobby-screen');
        
        // Jika mode manual, langsung ke form tantangan
        if (taskMode === 'manual') {
            document.getElementById('host-custom-tasks-section').style.display = 'block';
            setupCustomTasks();
        }
        
        return roomCode;
    });
}
 
function joinRoom(playerName, code) {
    myPlayerId = generateId();
    roomCode = code.toUpperCase();
    roomRef = database.ref('rooms/' + roomCode);

    return roomRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            throw new Error('Room tidak ditemukan');
        }

        const roomData = snapshot.val();
        const playerCount = Object.keys(roomData.players || {}).length;

        if (playerCount >= roomData.maxPlayers) {
            throw new Error('Room sudah penuh');
        }

        return roomRef.child('players/' + myPlayerId).set({
            name: playerName,
            position: 1,
            color: colors[playerCount % colors.length],
            ready: false,
            tasksCompleted: false,
            isCurrent: false
        });
    }).then(() => {
        setupRoomListeners();
        document.getElementById('guest-room-code').textContent = roomCode;
        switchScreen('guest-lobby-screen');

        // Atur UI berdasarkan taskMode
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            if (roomData.taskMode === 'manual') {
                document.getElementById('guest-custom-tasks-section').style.display = 'block';
                roomRef.child('players/' + myPlayerId).once('value').then(playerSnapshot => {
                    const player = playerSnapshot.val();
                    document.getElementById('guest-ready-btn').disabled = !player.tasksCompleted;
                });
            } else {
                document.getElementById('guest-custom-tasks-section').style.display = 'none';
                document.getElementById('guest-ready-btn').disabled = false;
            }
        });

        return roomCode;
    });
}


function setupRoomListeners() {
    // Listener untuk update data room
    roomRef.on('value', (snapshot) => {
        const roomData = snapshot.val();
        if (roomData) {
            console.log('Room data updated:', {
                status: roomData.status,
                players: Object.keys(roomData.players || {}).map(id => ({
                    id,
                    name: roomData.players[id].name,
                    ready: roomData.players[id].ready,
                    tasksCompleted: roomData.players[id].tasksCompleted
                })),
                currentPlayer: roomData.currentPlayer
            });
            updateGameUI(roomData);

            // Redirect ke layar game jika status playing
            if (roomData.status === "playing") {
                onGameStarted();
            }
        }
    });

    // Listener untuk player baru bergabung
    roomRef.child('players').on('child_added', (snapshot) => {
        const player = snapshot.val();
        console.log('Player joined:', player);
        onPlayerJoined(player);

        if (snapshot.key === myPlayerId && !isHost) {
            switchScreen('guest-lobby-screen');
            document.getElementById('guest-room-code').textContent = roomCode;

            roomRef.once('value').then(roomSnapshot => {
                const roomData = roomSnapshot.val();
                if (roomData.taskMode === 'manual' && !player.tasksCompleted) {
                    document.getElementById('guest-custom-tasks-section').style.display = 'block';
                } else {
                    document.getElementById('guest-custom-tasks-section').style.display = 'none';
                    document.getElementById('guest-ready-btn').disabled = false;
                }
            });
        }
    });

    // Listener untuk update data player
    roomRef.child('players').on('child_changed', (snapshot) => {
        const player = snapshot.val();
        console.log('Player updated:', player);
        onPlayerUpdated(player);
    });

    // Listener untuk perubahan giliran
    roomRef.child('currentPlayer').on('value', (snapshot) => {
        if (snapshot.exists()) {
            const currentPlayerId = snapshot.val();
            if (!currentPlayerId) return;

            if (!players || players.length === 0) {
                console.warn("Players array not initialized yet");
                return;
            }

            const playerIndex = players.findIndex(p => p.id === currentPlayerId);
            if (playerIndex >= 0) {
                currentPlayer = playerIndex;
                updateCurrentTurn();
            }
        }
    });
}


function movePlayer(steps) {
    return new Promise((resolve) => {
        const player = players.find(p => p.id === myPlayerId);
        if (!player) return resolve();

        let currentPos = positions[player.name];
        const targetPos = Math.min(currentPos + steps, 100);

        const moveInterval = setInterval(() => {
            if (currentPos < targetPos) {
                currentPos++;
                
                // Update position di Firebase dan lokal
                roomRef.child('players/' + myPlayerId + '/position').set(currentPos)
                    .then(() => {
                        positions[player.name] = currentPos;
                        updatePieces();
                        
                        if (currentPos === targetPos) {
                            clearInterval(moveInterval);
                            if (currentPos >= 100) {
                                showWinner(player);
                                resolve();
                            } else {
                                handleOnlineSnakesLadders(player).then(resolve);
                            }
                        }
                    });
            }
        }, 300);
    });
}
function handleOnlineSnakesLadders(player) {
    return roomRef.once('value').then(snapshot => {
        const roomData = snapshot.val();
        const currentPos = roomData.players[myPlayerId].position;

        if (snakes[currentPos]) {
            return movePlayerToPosition(player, snakes[currentPos], 'down');
        } else if (ladders[currentPos]) {
            return movePlayerToPosition(player, ladders[currentPos], 'up');
        } else {
            return checkOnlineTruthDare();
        }
    });
}

function movePlayerToPosition(player, targetPos, direction) {
    return new Promise((resolve) => {
        let currentPos = positions[player.name];
        
        const moveInterval = setInterval(() => {
            if ((direction === 'up' && currentPos < targetPos) || 
                (direction === 'down' && currentPos > targetPos)) {
                
                currentPos = direction === 'up' ? currentPos + 1 : currentPos - 1;
                
                roomRef.child('players/' + myPlayerId + '/position').set(currentPos)
                    .then(() => {
                        positions[player.name] = currentPos;
                        updatePieces();
                        
                        if ((direction === 'up' && currentPos === targetPos) ||
                            (direction === 'down' && currentPos === targetPos)) {
                            clearInterval(moveInterval);
                            checkOnlineTruthDare().then(resolve);
                        }
                    });
            }
        }, 200);
    });
}

function checkOnlineTruthDare() {
    return roomRef.once('value').then(snapshot => {
        const roomData = snapshot.val();
        const currentPos = roomData.players[myPlayerId].position;

        if (warningCells.includes(currentPos)) {
            if (taskMode === 'manual' && customTasks[currentPos]) {
                showCustomTaskModal(currentPos);
            } else {
                document.getElementById('truth-dare-modal').style.display = 'flex';
            }
            return false;
        }
        return true;
    }).then(shouldContinue => {
        if (shouldContinue) {
            return nextPlayer();
        }
    });
}

function showCustomTaskModal(cellNumber) {
    const cellTasks = customTasks[cellNumber];
    const randomTask = cellTasks[Math.floor(Math.random() * cellTasks.length)];
    
    document.getElementById('task-result').innerHTML = `
        <div class="task-card">
            <h3>${randomTask.type.toUpperCase()}</h3>
            <p>${randomTask.text}</p>
            <p class="task-item-cell">Dibuat oleh: ${randomTask.player || 'Sistem'}</p>
        </div>
    `;
    
    document.getElementById('truth-btn').style.display = 'none';
    document.getElementById('dare-btn').style.display = 'none';
    document.getElementById('continue-btn').style.display = 'block';
    document.getElementById('truth-dare-modal').style.display = 'flex';
}

function nextPlayer() {
    if (isOnlineGame) {
        return roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            if (!roomData) return;
            
            const playerIds = Object.keys(roomData.players || {});
            if (playerIds.length === 0) return;
            
            const currentIndex = playerIds.indexOf(roomData.currentPlayer);
            if (currentIndex === -1) return;
            
            // Cari index pemain berikutnya yang ready
            let nextIndex = (currentIndex + 1) % playerIds.length;
            let attempts = 0;
            const maxAttempts = playerIds.length;
            
            while (attempts < maxAttempts && 
                  !roomData.players[playerIds[nextIndex]].ready) {
                nextIndex = (nextIndex + 1) % playerIds.length;
                attempts++;
            }
            
            if (attempts >= maxAttempts) {
                console.error("No ready players found!");
                return;
            }
            
            const nextPlayerId = playerIds[nextIndex];
            
            // Update current player di Firebase
            return roomRef.update({
                currentPlayer: nextPlayerId
            });
        });
    } else {
        // Offline mode
        currentPlayer = (currentPlayer + 1) % players.length;
        updateCurrentTurn();
        return Promise.resolve();
    }
}
function startGame() {
    if (!roomCode) return Promise.reject("No room code");

    return roomRef.once('value').then(snapshot => {
        const roomData = snapshot.val();
        if (!roomData) throw new Error("Room data not found");

        // Pastikan host jalan pertama
        const firstPlayerId = roomData.host; 
        if (!firstPlayerId) throw new Error("Host ID not found");

        const playersData = roomData.players || {};

        // Cek apakah semua pemain ready
        const allReady = Object.values(playersData).every(player => player.ready);
        if (!allReady) {
            throw new Error("Masih ada pemain yang belum ready!");
        }

        // Cek apakah semua pemain telah menyelesaikan tantangan di mode manual
        if (roomData.taskMode === 'manual') {
            const allTasksCompleted = Object.values(playersData).every(player => player.tasksCompleted);
            if (!allTasksCompleted) {
                throw new Error("Masih ada pemain yang belum selesai membuat tantangan!");
            }
        }

        // Update status room ke "playing"
        return roomRef.update({
            status: "playing",
            currentPlayer: firstPlayerId,
            startedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }).then(() => {
        console.log("Game started successfully!");
        // Pastikan transisi ke layar game
        switchScreen('game-screen');
        initVoiceControl();
        return Promise.resolve();
    }).catch(error => {
        console.error("Gagal memulai game:", error);
        alert("Error: " + error.message);
        return Promise.reject(error);
    });
}


function leaveRoom() {
    if (!roomCode || !myPlayerId) return Promise.resolve();
    
    return roomRef.child('players/' + myPlayerId).remove().then(() => {
        // Check if room is empty
        return roomRef.child('players').once('value');
    }).then(snapshot => {
        if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
            // Delete room if empty
            return roomRef.remove();
        }
    }).then(() => {
        // Cleanup
        if (roomRef) {
            roomRef.child('currentPlayer').off(); // <-- BARU DITAMBAHKAN INI
            roomRef.off();
            roomRef = null;
        }
        roomCode = null;
        myPlayerId = null;
    });
}

// === CALLBACK FUNCTIONS ===
function updateGameUI(roomData) {
    if (!roomData) return;

    // Update player list
    const playersData = roomData.players || {};
    const playerList = isHost ? 
        document.getElementById('host-player-list') : 
        document.getElementById('guest-player-list');

    playerList.innerHTML = '';

    let readyCount = 0;
    let tasksCompletedCount = 0;
    let totalPlayers = 0;

    Object.keys(playersData).forEach(id => {
        const player = playersData[id];
        const statusText = player.ready ? 'Ready' : (player.tasksCompleted ? 'Tasks Done' : 'Waiting');
        addPlayerToList(player.name, id, id === roomData.host, player.tasksCompleted, statusText);
        if (player.ready) readyCount++;
        if (player.tasksCompleted) tasksCompletedCount++;
        totalPlayers++;
    });

    // Update start button for host
    if (isHost) {
        const startBtn = document.getElementById('host-start-btn');
        const isManualMode = roomData.taskMode === 'manual';

        // Enable start button if:
        // 1. Game status is "waiting"
        // 2. At least 2 players
        // 3. All players are ready
        // 4. For manual mode, all players have completed tasks
        const canStart = roomData.status === "waiting" && 
                         totalPlayers >= 2 && 
                         readyCount === totalPlayers && 
                         (!isManualMode || tasksCompletedCount === totalPlayers);

        startBtn.disabled = !canStart;

        // Debugging log
        console.log('Start Button Status:', {
            status: roomData.status,
            totalPlayers,
            readyCount,
            tasksCompletedCount,
            isManualMode,
            canStart
        });
    }
}


function onPlayerJoined(player) {
    console.log('Player joined:', player.name);
}

function onPlayerUpdated(player) {
    console.log('Player updated:', player);
    
    // Update player position if game is in progress
    if (roomRef && roomCode && myPlayerId) {
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            if (roomData.status === "playing") {
                positions[player.name] = player.position;
                updatePieces();
                updateScoreboard();
                
                // Check if player won
                if (player.position >= 100) {
                    showWinner(player);
                }
            }
        });
    }
}


function onGameStarted() {
    roomRef.once('value').then(snapshot => {
        const roomData = snapshot.val();
        if (!roomData || roomData.status !== "playing") return;
        
        // Initialize game state
        players = Object.entries(roomData.players || {}).map(([id, player], index) => ({
            id: id,
            name: player.name,
            color: player.color,
            number: index + 1
        }));
        
        positions = {};
        Object.entries(roomData.players || {}).forEach(([id, player]) => {
            positions[player.name] = player.position;
        });

        // Gabungkan semua custom tasks
        if (roomData.taskMode === 'manual') {
            customTasks = {};
            warningCells.length = 0;
            Object.values(roomData.players || {}).forEach(player => {
                if (player.customTasks) {
                    Object.keys(player.customTasks).forEach(cell => {
                        if (!customTasks[cell]) {
                            customTasks[cell] = [];
                        }
                        customTasks[cell].push(...player.customTasks[cell]);
                    });
                }
            });
            warningCells.push(...Object.keys(customTasks).map(Number).filter(cell => cell >= 1 && cell <= 100));
        }

        // Set current player berdasarkan data dari Firebase
        if (roomData.currentPlayer) {
            currentPlayer = players.findIndex(p => p.id === roomData.currentPlayer);
            if (currentPlayer === -1) {
                currentPlayer = 0; // Fallback ke player pertama jika tidak ditemukan
            }
        } else {
            currentPlayer = 0;
        }
        
        initBoard();
        updateScoreboard();
        updateCurrentTurn();
        
        document.getElementById('online-status').style.display = 'block';
        document.getElementById('room-code-badge').textContent = "Room: " + roomCode;
        
        // Pastikan semua pemain beralih ke layar game
        switchScreen('game-screen');
        initVoiceControl();
    }).catch(error => {
        console.error("Error in onGameStarted:", error);
        alert("Error saat memulai game: " + error.message);
    });
}

// === GAME FUNCTIONS ===
function initGame() {
    // Setup event listeners
    document.getElementById('start-btn').onclick = function() {
        switchScreen('mode-screen');
    };

    // Mode selection
    document.getElementById('offline-mode').onclick = function() {
        isOnlineGame = false;
        switchScreen('rules-screen');
    };

    document.getElementById('online-mode').onclick = function() {
        isOnlineGame = true;
        switchScreen('online-options-screen');
    };

    // Task mode selection
    document.getElementById('system-mode').onclick = function() {
        document.getElementById('system-mode').classList.add('selected');
        document.getElementById('manual-mode').classList.remove('selected');
        taskMode = 'system';
    };

    document.getElementById('manual-mode').onclick = function() {
        document.getElementById('manual-mode').classList.add('selected');
        document.getElementById('system-mode').classList.remove('selected');
        taskMode = 'manual';
    };

    document.getElementById('task-mode-confirm').onclick = function() {
        if (!taskMode) {
            alert('Pilih mode tantangan terlebih dahulu');
            return;
        }

        if (taskMode === 'system') {
            initBoard();
            updateScoreboard();
            updateCurrentTurn();
            switchScreen('game-screen');
            initVoiceControl();
        } else {
            setupCustomTasks();
        }
    };

    // Custom task functions
    document.getElementById('add-task-btn').onclick = addCustomTask;
    document.getElementById('finish-tasks-btn').onclick = finishPlayerTasks;

    // Online game options
    document.getElementById('create-room-btn').onclick = function() {
        isHost = true;
        switchScreen('create-room-screen');
    };

    document.getElementById('join-room-btn').onclick = function() {
        isHost = false;
        switchScreen('join-room-screen');
    };

    // Create room
    document.getElementById('create-room-confirm').onclick = function() {
        const name = document.getElementById('host-name').value;
        maxPlayers = parseInt(document.getElementById('max-players').value);
        taskMode = document.getElementById('task-mode').value;
        
        if (!name) {
            alert('Mohon masukkan nama Anda');
            return;
        }
        
        createRoom(name).then(code => {
            document.getElementById('room-code-display').textContent = code;
            switchScreen('host-lobby-screen');
            
            // Show custom task section if in manual mode
            if (taskMode === 'manual') {
                document.getElementById('host-custom-tasks-section').style.display = 'block';
            }
        }).catch(error => {
            alert('Gagal membuat room: ' + error.message);
        });
    };

    // Guest setup tasks
document.getElementById('guest-setup-tasks-btn').onclick = function() {
    roomRef.child('players').once('value').then(snapshot => {
        const playersData = snapshot.val();
        players = [];

        Object.keys(playersData).forEach((id, index) => {
            const player = playersData[id];
            players.push({
                name: player.name,
                color: player.color,
                number: index + 1,
                id: id
            });
            positions[player.name] = player.position;
        });
         // Periksa apakah guest sudah selesai membuat tantangan
        roomRef.child('players/' + myPlayerId).once('value').then(playerSnapshot => {
            const player = playerSnapshot.val();
            if (!player.tasksCompleted) {
                setupCustomTasks();
            } else {
                alert("Anda sudah selesai membuat tantangan!");
                switchScreen('guest-lobby-screen');
            }
        });
    });
};

    // Host setup tasks
    document.getElementById('host-setup-tasks-btn').onclick = function() {
        roomRef.child('players').once('value').then(snapshot => {
            const playersData = snapshot.val();
            players = [];
            
            Object.keys(playersData).forEach((id, index) => {
                const player = playersData[id];
                players.push({
                    name: player.name,
                    color: player.color,
                    number: index + 1,
                    id: id
                });
                positions[player.name] = player.position;
            });
            
            setupCustomTasks();
        });
    };

    // Join room
    document.getElementById('join-room-confirm').onclick = function() {
        const name = document.getElementById('join-player-name').value;
        const code = document.getElementById('room-code').value;
        
        if (!name || !code) {
            alert('Mohon masukkan nama dan kode room');
            return;
        }
        
        joinRoom(name, code).then(code => {
            document.getElementById('guest-room-code').textContent = code;
        }).catch(error => {
            alert('Gagal bergabung: ' + error.message);
            switchScreen('online-options-screen');
        });
    };

    
document.getElementById('guest-ready-btn').onclick = function() {
    if (!isHost && roomRef && myPlayerId) {
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            if (roomData.taskMode === 'manual') {
                return roomRef.child('players/' + myPlayerId).once('value').then(playerSnapshot => {
                    const player = playerSnapshot.val();
                    if (!player.tasksCompleted) {
                        alert("Silakan buat tantangan terlebih dahulu!");
                        return;
                    }
                    return roomRef.child('players/' + myPlayerId).update({
                        ready: true,
                        tasksCompleted: true
                    });
                });
            } else {
                return roomRef.child('players/' + myPlayerId).update({
                    ready: true
                });
            }
        }).then(() => {
            console.log(`Pemain ${myPlayerId} berhasil set ready`);
            alert("Status Anda sudah siap! Menunggu host memulai game...");
            document.getElementById('guest-ready-btn').disabled = true;
        }).catch(error => {
            console.error("Gagal set ready:", error);
            alert("Error: " + error.message);
        });
    }
};

    // Host starts the game
        document.getElementById('host-start-btn').onclick = function() {
    startGame().then(() => {
        console.log("Game dimulai!");
    }).catch(error => {
        console.error("Error:", error);
        alert('Gagal memulai game: ' + error.message);
    });
};

    document.getElementById('online-start-btn').onclick = function() {
        if (!isHost && roomRef && myPlayerId) {
            roomRef.child('players/' + myPlayerId + '/ready').set(true)
                .then(() => {
                    switchScreen('game-screen');
                    initVoiceControl();
                })
                .catch(error => {
                    alert("Error: " + error.message);
                });
        }
    };

    // Start online game
    document.getElementById('online-start-btn').onclick = function() {
        startOnlineGame();
    };

    // Offline game flow
    document.getElementById('next-btn').onclick = function() {
        switchScreen('count-screen');
    };

    const countButtons = document.querySelectorAll('.count-btn');
    countButtons.forEach(function(button) {
        button.onclick = function() {
            playerCount = parseInt(this.getAttribute('data-count'));
            setupPlayerInputs();
            switchScreen('names-screen');
        };
    });

    document.getElementById('start-game-btn').onclick = function() {
        const inputs = document.querySelectorAll('#player-inputs input');
        players = [];
        positions = {};
        
        inputs.forEach(function(input, index) {
            const player = {
                name: input.value.trim(),
                color: colors[index],
                number: index + 1
            };
            players.push(player);
            positions[player.name] = 1;
        });
        
        switchScreen('task-mode-screen');
    };

    document.getElementById('roll-btn').onclick = function() {
        if (isOnlineGame) {
            roomRef.once('value').then(snapshot => {
                const roomData = snapshot.val();
                if (roomData.currentPlayer === myPlayerId) {
                    rollDice();
                } else {
                    alert("Tunggu giliran Anda!");
                }
            });
        } else {
            rollDice();
        }
    };

    document.getElementById('truth-btn').onclick = function() {
        showTask('truth');
    };

    document.getElementById('dare-btn').onclick = function() {
        showTask('dare');
    };

    document.getElementById('continue-btn').onclick = function() {
        continueGame();
    };

    document.getElementById('play-again-btn').onclick = function() {
        resetGame();
    };

    // Start with first screen
    switchScreen('start-screen');
}

// === VOICE CONTROL ===
function initVoiceControl() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        document.getElementById('mic-btn').style.display = 'none';
        document.getElementById('mic-status').textContent = "Browser tidak mendukung voice control!";
        return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = function() {
        isListening = true;
        document.getElementById('mic-btn').classList.add('active');
        document.getElementById('mic-status').textContent = "Mendengarkan...";
    };

    recognition.onend = function() {
        isListening = false;
        document.getElementById('mic-btn').classList.remove('active');
        document.getElementById('mic-status').textContent = "Klik mic atau bilang 'MULAI'";
        
        if (document.getElementById('game-screen').classList.contains('active')) {
            setTimeout(() => {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Error restarting recognition:", e);
                }
            }, 500);
        }
    };

    recognition.onresult = function(event) {
        const last = event.results.length - 1;
        const command = event.results[last][0].transcript.trim().toUpperCase();
        
        if (command.includes("MULAI") || command.includes("LEMPAR DADU") || command.includes("JALAN") || command.includes("SEPI GO")) {
            document.getElementById('mic-status').textContent = "Terdeteksi: " + command;
            rollDice();
        }
    };

    recognition.onerror = function(event) {
        console.error('Error:', event.error);
        let errorMsg = "Error: ";
        const micBtn = document.getElementById('mic-btn');
        
        micBtn.classList.remove('active');
        micBtn.classList.add('error');
        
        switch(event.error) {
            case 'not-allowed':
                errorMsg = "Izin mikrofon ditolak. Klik ikon mic untuk mengizinkan.";
                break;
            case 'no-speech':
                errorMsg = "Tidak terdeteksi suara. Coba lagi.";
                break;
            case 'audio-capture':
                errorMsg = "Tidak ada mikrofon yang terdeteksi.";
                break;
            default:
                errorMsg = "Error: " + event.error;
        }
        document.getElementById('mic-status').textContent = errorMsg;
    };

    document.getElementById('mic-btn').onclick = function() {
        try {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        } catch (error) {
            document.getElementById('mic-status').textContent = "Error: " + error.message;
        }
    };
}

// === UI FUNCTIONS ===
function switchScreen(screenId) {
    const screens = document.querySelectorAll('.screen');
    screens.forEach(function(screen) {
        if (screen.id === screenId) {
            screen.classList.add('active');
            
            if (screenId === 'game-screen') {
                initVoiceControl();
            }
        } else {
            screen.classList.remove('active');
        }
    });
}

function setupPlayerInputs() {
    const container = document.getElementById('player-inputs');
    container.innerHTML = '';

    for (let i = 0; i < playerCount; i++) {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-input';

        const colorDiv = document.createElement('div');
        colorDiv.className = 'color-preview';
        colorDiv.style.backgroundColor = colors[i];
        colorDiv.textContent = i + 1;

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Nama Pemain ' + (i + 1);
        input.required = true;

        playerDiv.appendChild(colorDiv);
        playerDiv.appendChild(input);
        container.appendChild(playerDiv);
    }
}

function addPlayerToList(name, id, isAdmin = false, tasksCompleted = false, statusText = 'Waiting') {
    const playerList = isHost ? 
        document.getElementById('host-player-list') : 
        document.getElementById('guest-player-list');

    const existingPlayer = document.getElementById('player-' + id);
    if (existingPlayer) {
        existingPlayer.remove();
    }

    const playerItem = document.createElement('div');
    playerItem.className = 'player-item';
    playerItem.id = 'player-' + id;

    const playerInfo = document.createElement('div');
    playerInfo.className = 'player-info';

    const playerAvatar = document.createElement('div');
    playerAvatar.className = 'player-avatar';
    playerAvatar.textContent = name.charAt(0).toUpperCase();
    playerAvatar.style.backgroundColor = colors[playerList.children.length % colors.length];

    const playerName = document.createElement('span');
    playerName.textContent = name;

    const playerStatus = document.createElement('div');
    playerStatus.className = 'player-status';
    playerStatus.textContent = isAdmin ? 'Admin' : (statusText === 'Ready' ? 'Ready' : tasksCompleted ? 'Tasks Done' : 'Waiting');
    if (isAdmin) playerStatus.classList.add('admin');
    if (statusText === 'Ready') {
        playerStatus.classList.add('ready');
        playerStatus.style.backgroundColor = 'var(--success)';
    } else if (tasksCompleted && statusText !== 'Ready') {
        playerStatus.style.backgroundColor = '#FFD700';
    }

    playerInfo.appendChild(playerAvatar);
    playerInfo.appendChild(playerName);
    playerItem.appendChild(playerInfo);
    playerItem.appendChild(playerStatus);
    playerList.appendChild(playerItem);

    if (isHost) {
        updateStartButton();
    }
}

function updateStartButton() {
    if (!isHost) return;
    
    const playerCount = document.getElementById('host-player-list').children.length;
    const startBtn = document.getElementById('host-start-btn');
    
    if (playerCount >= 2) {
        startBtn.disabled = false;
    } else {
        startBtn.disabled = true;
    }
}

// === GAME LOGIC ===
function startOnlineGame() {
    if (isHost) {
        startGame().catch(error => {
            console.error("Error starting game:", error);
        });
    }
}

function rollDice() {
    const dice = document.getElementById('dice');
    const rollBtn = document.getElementById('roll-btn');
    
    rollBtn.disabled = true;
    dice.classList.add('rolling');

    let rolls = 0;
    const maxRolls = 10;
    const rollInterval = setInterval(() => {
        dice.textContent = Math.floor(Math.random() * 6) + 1;
        rolls++;

        if (rolls >= maxRolls) {
            clearInterval(rollInterval);
            const diceValue = Math.floor(Math.random() * 6) + 1;
            dice.textContent = diceValue;
            dice.classList.remove('rolling');
            
            if (isOnlineGame) {
                roomRef.once('value').then(snapshot => {
                    const roomData = snapshot.val();
                    if (roomData.currentPlayer === myPlayerId) {
                        movePlayer(diceValue).finally(() => {
                            rollBtn.disabled = false;
                        });
                    } else {
                        alert("Bukan giliran Anda!");
                        rollBtn.disabled = false;
                    }
                });
            } else {
                movePlayerOffline(diceValue);
                rollBtn.disabled = false;
            }
        }
    }, 100);
}

function movePlayerOffline(steps) {
    const player = players[currentPlayer];
    const rollBtn = document.getElementById('roll-btn');
    rollBtn.disabled = true;

    let currentPosition = positions[player.name];
    const targetPosition = Math.min(currentPosition + steps, 100);
    
    const moveInterval = setInterval(() => {
        if (currentPosition < targetPosition) {
            currentPosition++;
            positions[player.name] = currentPosition;
            updatePieces();
            updateScoreboard();
        } else {
            clearInterval(moveInterval);
            
            if (currentPosition >= 100) {
                showWinner(player);
                return;
            }
            
            handleSnakesAndLadders(player);
        }
    }, 300);
}

function handleSnakesAndLadders(player) {
    const currentPos = positions[player.name];
    
    if (snakes[currentPos]) {
        const targetPos = snakes[currentPos];
        const snakeAnimation = setInterval(function() {
            if (positions[player.name] > targetPos) {
                positions[player.name]--;
                updatePieces();
                updateScoreboard();
            } else {
                clearInterval(snakeAnimation);
                checkTruthDare();
            }
        }, 200);
    } else if (ladders[currentPos]) {
        const targetPos = ladders[currentPos];
        const ladderAnimation = setInterval(function() {
            if (positions[player.name] < targetPos) {
                positions[player.name]++;
                updatePieces();
                updateScoreboard();
            } else {
                clearInterval(ladderAnimation);
                checkTruthDare();
            }
        }, 200);
    } else {
        checkTruthDare();
    }
}

function checkTruthDare() {
    const player = players[currentPlayer];
    const rollBtn = document.getElementById('roll-btn');
    
    if (warningCells.includes(positions[player.name])) {
        if (taskMode === 'manual' && customTasks[positions[player.name]]) {
            const cellTasks = customTasks[positions[player.name]];
            const randomTask = cellTasks[Math.floor(Math.random() * cellTasks.length)];
            
            document.getElementById('task-result').innerHTML = `
                <div class="task-card">
                    <h3>${randomTask.type.toUpperCase()}</h3>
                    <p>${randomTask.text}</p>
                    <p class="task-item-cell">Dibuat oleh: ${randomTask.player || 'Sistem'}</p>
                </div>
            `;
            
            document.getElementById('truth-btn').style.display = 'none';
            document.getElementById('dare-btn').style.display = 'none';
            document.getElementById('continue-btn').style.display = 'block';
            document.getElementById('truth-dare-modal').style.display = 'flex';
        } else {
            document.getElementById('truth-dare-modal').style.display = 'flex';
            document.getElementById('task-result').innerHTML = '';
            document.getElementById('truth-btn').style.display = 'inline-block';
            document.getElementById('dare-btn').style.display = 'inline-block';
            document.getElementById('continue-btn').style.display = 'none';
        }
    } else {
        nextPlayer();
    }
    rollBtn.disabled = false;
}

function initBoard() {
    const board = document.getElementById('game-board');
    board.innerHTML = '';

    const customBoardOrder = [
        [100, 99, 98, 97, 96, 95, 94, 93, 92, 91],
        [81, 82, 83, 84, 85, 86, 87, 88, 89, 90],
        [80, 79, 78, 77, 76, 75, 74, 73, 72, 71],
        [61, 62, 63, 64, 65, 66, 67, 68, 69, 70],
        [60, 59, 58, 57, 56, 55, 54, 53, 52, 51],
        [41, 42, 43, 44, 45, 46, 47, 48, 49, 50],
        [40, 39, 38, 37, 36, 35, 34, 33, 32, 31],
        [21, 22, 23, 24, 25, 26, 27, 28, 29, 30],
        [20, 19, 18, 17, 16, 15, 14, 13, 12, 11],
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    ];

    for (let row = 0; row < customBoardOrder.length; row++) {
        for (let col = 0; col < customBoardOrder[row].length; col++) {
            const cellNumber = customBoardOrder[row][col];
            const cell = document.createElement('div');
            cell.className = 'cell';
            
            const cellNumberSpan = document.createElement('span');
            cellNumberSpan.className = 'cell-number';
            cellNumberSpan.textContent = cellNumber;
            cell.appendChild(cellNumberSpan);

            if (snakes[cellNumber]) {
                cell.classList.add('snake');
                const snakeIcon = document.createElement('i');
                snakeIcon.className = 'fas fa-snake';
                cell.appendChild(snakeIcon);
            } else if (ladders[cellNumber]) {
                cell.classList.add('ladder');
                const ladderIcon = document.createElement('i');
                ladderIcon.className = 'fas fa-ladder';
                cell.appendChild(ladderIcon);
            } else if (warningCells.includes(cellNumber)) {
                cell.classList.add('warning');
                const warningIcon = document.createElement('i');
                warningIcon.className = 'fas fa-exclamation';
                cell.appendChild(warningIcon);
            }

            board.appendChild(cell);
        }
    }

    updatePieces();
}
function updatePieces() {
    const pieces = document.querySelectorAll('.piece');
    pieces.forEach(piece => piece.remove());

    for (const name in positions) {
        const player = players.find(p => p.name === name);
        if (!player) continue;

        const position = positions[name];
        const cells = document.querySelectorAll('#game-board .cell');
        
        let targetCellIndex = -1;
        cells.forEach((cell, index) => {
            const cellNumber = parseInt(cell.querySelector('.cell-number').textContent);
            if (cellNumber === position) {
                targetCellIndex = index;
            }
        });

        if (targetCellIndex !== -1 && cells[targetCellIndex]) {
            const piece = document.createElement('div');
            piece.className = 'piece';
            piece.style.backgroundColor = player.color;
            piece.textContent = player.number;
            piece.title = `${player.name} (Posisi: ${position})`;
            cells[targetCellIndex].appendChild(piece);
        }
    }
}

function updateScoreboard() {
    const scoreList = document.getElementById('score-list');
    scoreList.innerHTML = '';

    const sortedPlayers = [...players].sort(function(a, b) {
        return positions[b.name] - positions[a.name];
    });

    sortedPlayers.forEach(function(player, index) {
        const scoreItem = document.createElement('div');
        scoreItem.className = 'score-item';

        const playerRank = document.createElement('div');
        playerRank.className = 'player-rank';

        const playerColor = document.createElement('div');
        playerColor.className = 'player-color';
        playerColor.style.backgroundColor = player.color;

        const playerName = document.createElement('span');
        playerName.textContent = player.name;

        const playerPosition = document.createElement('div');
        playerPosition.className = 'player-position';
        playerPosition.textContent = positions[player.name];

        playerRank.appendChild(playerColor);
        playerRank.appendChild(playerName);
        scoreItem.appendChild(playerRank);
        scoreItem.appendChild(playerPosition);
        scoreList.appendChild(scoreItem);
    });
}

function updateCurrentTurn() {
    const player = players[currentPlayer];
    if (!player) return;
    
    const turnDisplay = document.getElementById('current-turn');
    document.getElementById('turn-text').textContent = `Giliran: ${player.name}`;
    turnDisplay.style.color = player.color;
    document.querySelector('.current-turn-indicator').style.backgroundColor = player.color;
}

function nextPlayer() {
    if (isOnlineGame) {
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            const playerIds = Object.keys(roomData.players);
            const currentIndex = playerIds.indexOf(roomData.currentPlayer);
            
            // Cari index pemain berikutnya yang ready
            let nextIndex = (currentIndex + 1) % playerIds.length;
            while (nextIndex !== currentIndex && !roomData.players[playerIds[nextIndex]].ready) {
                nextIndex = (nextIndex + 1) % playerIds.length;
            }
            
            // Jika semua pemain tidak ready (shouldn't happen)
            if (!roomData.players[playerIds[nextIndex]].ready) {
                console.error("No ready players found!");
                return;
            }
            
            // Update current player di Firebase
            return roomRef.update({
                currentPlayer: playerIds[nextIndex]
            }).then(() => {
                // Update local currentPlayer
                currentPlayer = players.findIndex(p => p.id === playerIds[nextIndex]);
                updateCurrentTurn();
            });
        });
    } else {
        // Offline mode
        currentPlayer = (currentPlayer + 1) % players.length;
        updateCurrentTurn();
    }
}

function showTask(type) {
    const taskResult = document.getElementById('task-result');
    const tasksArray = tasks[type];
    const randomTask = tasksArray[Math.floor(Math.random() * tasksArray.length)];

    taskResult.innerHTML = `
        <div class="task-card">
            <h3>${type.toUpperCase()}</h3>
            <p>${randomTask}</p>
        </div>
    `;

    document.getElementById('continue-btn').style.display = 'block';
    document.getElementById('truth-btn').style.display = 'none';
    document.getElementById('dare-btn').style.display = 'none';
}

function continueGame() {
    document.getElementById('truth-dare-modal').style.display = 'none';
    document.getElementById('task-result').innerHTML = '';
    document.getElementById('continue-btn').style.display = 'none';
    document.getElementById('truth-btn').style.display = 'inline-block';
    document.getElementById('dare-btn').style.display = 'inline-block';

    nextPlayer();
}

function showWinner(player) {
    document.getElementById('winner-name').textContent = player.name;
    document.getElementById('winner-name').style.color = player.color;
    document.getElementById('winner-modal').style.display = 'flex';

    if (recognition) {
        recognition.stop();
    }

    for (let i = 0; i < 100; i++) {
        createConfetti();
    }
}

function createConfetti() {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = (Math.random() * 10 + 5) + 'px';
    confetti.style.height = (Math.random() * 10 + 5) + 'px';
    confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
    document.body.appendChild(confetti);

    setTimeout(function() {
        confetti.remove();
    }, 3000);
}

function resetGame() {
    document.getElementById('winner-modal').style.display = 'none';
    
    if (isOnlineGame) {
        leaveRoom().then(() => {
            isHost = false;
            roomCode = '';
            myPlayerId = '';
            maxPlayers = 2;
            
            document.getElementById('host-player-list').innerHTML = '';
            document.getElementById('guest-player-list').innerHTML = '';
            document.getElementById('online-status').style.display = 'none';
            
            switchScreen('start-screen');
        });
    } else {
        switchScreen('start-screen');
    }
}

// === CUSTOM TASK FUNCTIONS ===
function setupCustomTasks() {
    customTasks = {};
    playerTasks = [];
    currentTaskPlayer = 0;

    updateTaskPlayerUI();

    // Kosongkan input form
    document.getElementById('task-list').innerHTML = '<p class="text-center">Belum ada tantangan ditambahkan</p>';
    document.getElementById('task-text').value = '';
    document.getElementById('task-cell').value = '';
    document.getElementById('finish-tasks-btn').disabled = true;

    switchScreen('custom-task-screen');
}

function updateTaskPlayerUI() {
    if (isOnlineGame) {
        // Mode online: tampilkan nama pemain saat ini berdasarkan myPlayerId
        roomRef.child('players/' + myPlayerId).once('value').then(snapshot => {
            const player = snapshot.val();
            if (!player) {
                console.error("Pemain tidak ditemukan untuk myPlayerId:", myPlayerId);
                alert("Gagal memuat data pemain!");
                return;
            }

            document.getElementById('current-player-name').textContent = player.name;
            document.getElementById('current-player-number').textContent = 1;
            document.getElementById('total-players').textContent = 1;

            document.getElementById('task-list').innerHTML = '<p class="text-center">Belum ada tantangan ditambahkan</p>';
            document.getElementById('task-text').value = '';
            document.getElementById('task-cell').value = '';
            
            document.getElementById('finish-tasks-btn').disabled = true;

             document.getElementById('add-task-btn').disabled = false;
        }).catch(error => {
            console.error("Gagal mengambil data pemain:", error);
            alert("Gagal memuat data pemain: " + error.message);
        });
    } else {
        // Mode offline: iterasi pemain seperti biasa
        document.getElementById('current-player-name').textContent = players[currentTaskPlayer].name;
        document.getElementById('current-player-number').textContent = currentTaskPlayer + 1;
        document.getElementById('total-players').textContent = players.length;

        document.getElementById('task-list').innerHTML = '<p class="text-center">Belum ada tantangan ditambahkan</p>';
        document.getElementById('task-text').value = '';
        document.getElementById('task-cell').value = '';
        
        document.getElementById('finish-tasks-btn').disabled = true;
        document.getElementById('add-task-btn').disabled = false;
    }
}

function addCustomTask() {
    const type = document.getElementById('task-type').value;
    const text = document.getElementById('task-text').value.trim();
    const cell = parseInt(document.getElementById('task-cell').value);
    
    if (!text) {
        alert('Mohon masukkan teks tantangan');
        return;
    }
    
    if (isNaN(cell)) {
        alert('Mohon masukkan nomor kotak yang valid (1-100)');
        return;
    }
    
    if (cell < 1 || cell > 100) {
        alert('Nomor kotak harus antara 1 dan 100');
        return;
    }
    
    // Validasi: Pastikan kotak bukan ular atau tangga
    if (snakes[cell] || ladders[cell]) {
        alert('Kotak ini adalah ular atau tangga, pilih kotak lain!');
        return;
    }
    
    const currentPlayerTasks = playerTasks.filter(task => task.player === players.find(p => p.id === myPlayerId)?.name);
    const truthCount = currentPlayerTasks.filter(task => task.type === 'truth').length;
    const dareCount = currentPlayerTasks.filter(task => task.type === 'dare').length;

    if (type === 'truth' && truthCount >= 2) {
        alert('Anda sudah membuat 2 Truth! Tidak bisa menambah lagi.');
        return;
    }
    if (type === 'dare' && dareCount >= 2) {
        alert('Anda sudah membuat 2 Dare! Tidak bisa menambah lagi.');
        return;
    }

    const task = {
        type,
        text,
        cell,
        player: players.find(p => p.id === myPlayerId)?.name
    };
    
    playerTasks.push(task);
    updateTaskListUI();
    
    document.getElementById('task-text').value = '';
    document.getElementById('task-cell').value = '';
    
    const newTruthCount = currentPlayerTasks.filter(task => task.type === 'truth').length + (type === 'truth' ? 1 : 0);
    const newDareCount = currentPlayerTasks.filter(task => task.type === 'dare').length + (type === 'dare' ? 1 : 0);

    if (newTruthCount >= 2 && newDareCount >= 2) {
        document.getElementById('finish-tasks-btn').disabled = false;
        document.getElementById('add-task-btn').disabled = true;
    } else {
        document.getElementById('finish-tasks-btn').disabled = false;
    }
    }

function updateTaskListUI() {
    const taskList = document.getElementById('task-list');
    
    if (playerTasks.length === 0) {
        taskList.innerHTML = '<p class="text-center">Belum ada tantangan ditambahkan</p>';
        return;
    }
    
    taskList.innerHTML = '';
    
    playerTasks.forEach((task, index) => {
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        
        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-item-info';
        
        const taskType = document.createElement('div');
        taskType.className = 'task-item-type';
        taskType.textContent = task.type.toUpperCase();
        
        const taskText = document.createElement('div');
        taskText.textContent = task.text;
        
        const taskCell = document.createElement('div');
        taskCell.className = 'task-item-cell';
        taskCell.textContent = `Kotak ${task.cell}`;
        
        taskInfo.appendChild(taskType);
        taskInfo.appendChild(taskText);
        taskInfo.appendChild(taskCell);
        
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'task-item-delete';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = () => removeTask(index);
        
        taskItem.appendChild(taskInfo);
        taskItem.appendChild(deleteBtn);
        taskList.appendChild(taskItem);
    });
}

function removeTask(index) {
    playerTasks.splice(index, 1);
    updateTaskListUI();
    document.getElementById('finish-tasks-btn').disabled = playerTasks.length === 0;
    document.getElementById('add-task-btn').disabled = false;
}

    function finishPlayerTasks() {
    if (isOnlineGame) {
        const playerTasksData = {};
        playerTasks.forEach(task => {
            if (!playerTasksData[task.cell]) {
                playerTasksData[task.cell] = [];
            }
            playerTasksData[task.cell].push({
                type: task.type,
                text: task.text,
                player: task.player
            });
        });

        roomRef.child('players/' + myPlayerId + '/customTasks').set(playerTasksData)
            .then(() => {
                return roomRef.child('players/' + myPlayerId).update({
                    tasksCompleted: true,
                    ready: true // Otomatis set ready setelah selesai
                });
            })
            .then(() => {
                playerTasks = [];
                if (isHost) {
                    switchScreen('host-lobby-screen');
                } else {
                    switchScreen('guest-lobby-screen');
                    document.getElementById('guest-ready-btn').disabled = true;
                }
            })
            .catch(error => {
                console.error("Gagal menyimpan tantangan:", error);
                alert("Gagal menyimpan tantangan: " + error.message);
            });
    } else {
        const playerName = players[currentTaskPlayer].name;

        customTasks[playerName] = [...playerTasks];
        playerTasks = [];
        currentTaskPlayer++;

        if (currentTaskPlayer < players.length) {
            updateTaskPlayerUI();
        } else {
            const allTasksByCell = {};
            players.forEach(player => {
                const tasks = customTasks[player.name] || [];
                tasks.forEach(task => {
                    if (!allTasksByCell[task.cell]) {
                        allTasksByCell[task.cell] = [];
                    }
                    allTasksByCell[task.cell].push({
                        type: task.type,
                        text: task.text,
                        player: player.name
                    });
                });
            });

            warningCells.length = 0;
            customTasks = allTasksByCell;
            warningCells.push(...Object.keys(customTasks).map(Number).filter(cell => cell >= 1 && cell <= 100));

            initBoard();
            updateScoreboard();
            updateCurrentTurn();
            switchScreen('game-screen');
            initVoiceControl();
        }
    }
    }




function startGameWithCustomTasks() {
    return new Promise((resolve, reject) => {
        // Perbarui warningCells berdasarkan customTasks
        warningCells.length = 0;
        warningCells.push(...Object.keys(customTasks).map(Number).filter(cell => cell >= 1 && cell <= 100));
        
        if (isOnlineGame) {
            // Untuk mode online, simpan ke Firebase
            roomRef.update({
                customTasks: customTasks,
                warningCells: warningCells
            }).then(() => {
                resolve();
            }).catch(error => {
                reject(error);
            });
        } else {
            // Untuk mode offline, langsung resolve karena data sudah disimpan di customTasks
            resolve();
        }
    });
} 

// === UTILITY FUNCTIONS ===
function getRandomColor() {
    return colors[Math.floor(Math.random() * colors.length)];
}

function getCurrentPlayer() {
    return players[currentPlayer];
}

function isCurrentPlayer(playerId) {
    if (!isOnlineGame) return true;
    return playerId === myPlayerId;
}

// === INITIALIZE GAME ===
document.addEventListener('DOMContentLoaded', function() {
    initGame();
});

    
</script>

</body>
    </html>

        
